# 作用

1、如果`koa`返回对象为非常大的`json`对象时，避免在对大`json`进行`stringify`时独占`cpu`时间，导致应用无法响应其它连接；

2、优化`koa`返回大`json`对象由于对象在内存中停留时间过久（接收端由于网络、处理速度慢等）而导致内存暴涨从而触发`OOM`异常；

# 原理

1、将应用返回的`json`数据进行`stringify`，并通过流写入本地临时文件缓存，及时释放对象占用的内存空间，然后通过文件流将结果写入`ctx.res`。

在接受端出现由于网速、处理速度慢等状况时，将结果缓存入本地文件将大大加快处理速度（顺序写入，虽不能保证完全的顺序写入，但可以通过服务器闲

时碎片整理等方式提高顺序写入的几率）从而减少内存中停留时间；

2、利用`nodejs`提供对流处理的`背压反馈`机制，在`json stringify`时，利用该机制可以使得写入文件时降低内存使用，即生产流过快时，通过等待消费流

消费完成反馈后才继续进行`stringify`流生产工作，（参考文章： https://nodejs.org/zh-cn/docs/guides/backpressuring-in-streams/ ）；

3、对异步`stringify`方式进行速度上的进一步优化，即通过`parsedLevel >= DEFAULT_PARSED_LEVEL`机制对于子对象或数组`item`进行`stringify`

时，如果预估子对象或数组`item`不是大对象（可以通过定制化传参`level`以根据实际业务场景做优化），则可以直接调用`JSON.stringify`方法（`native`方

法，相较于`js`代码执行更快）；

4、尤其对于数组的优化，采取了`arr.shift()`方式在进行`stringify`的同时，直接将代码`item`的引用数减为`0`， 使得该部分内存可以及时被回收；

# 其它想法

1、对于某些查询也可以使用该方式将查询结果缓存起来（例如：文件名即为`path?params`方式），下次查询时将根据缓存生效时间内直接返回调用方。
